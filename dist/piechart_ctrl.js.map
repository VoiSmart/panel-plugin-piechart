{"version":3,"sources":["../src/piechart_ctrl.js"],"names":["MetricsPanelCtrl","_","appEvents","kbn","TimeSeries","rendering","legend","moment","fileExport","PieChartCtrl","$scope","$injector","$rootScope","variableSrv","variableNames","map","variables","selectedSeries","timeBuckets","undefined","focusedTime","focusedBucketIndex","panelDefaults","pieType","show","values","tooltip","links","datasource","maxDataPoints","interval","targets","cacheTimeout","nullPointMode","legendType","aliasColors","format","valueName","strokeWidth","fontSize","combine","threshold","label","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","onInitPanelActions","onGraphHover","event","pos","date","utc","x1","unix","index","findLastIndex","t","render","addEditorTab","unitFormats","getUnitFormats","subItem","value","series","color","alias","data","parseSeries","clickAction","variable","find","variableToUpdate","selected","filter","options","constructor","Array","i","length","serie","stats","flotpairs","arr","seriesData","colors","dataList","seriesHandler","datapoints","target","getFlotPairs","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","scope","elem","attrs","ctrl","actions","push","text","click","refresh","seriesList","total","formatValue","pvalue","toFixed","saveSaveBlob","combined","toggleSeries","keys","current","join","updateOptions","then","variableUpdated","$emit","$root","$broadcast","templateUrl"],"mappings":"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","file":"piechart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport { appEvents } from 'app/core/core';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport rendering from './rendering';\nimport legend from './legend';\nimport moment from 'moment';\nimport * as fileExport from 'app/core/utils/file_export';\n\nexport class PieChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope, variableSrv) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.variableSrv = variableSrv;\n    this.variableNames = _.map(variableSrv.variables, 'name');\n    this.selectedSeries = {};\n    this.timeBuckets = undefined;\n    this.focusedTime = undefined;\n    this.focusedBucketIndex = undefined;\n\n    var panelDefaults = {\n      pieType: 'pie',\n      legend: {\n        show: true, // disable/enable legend\n        values: true\n      },\n      tooltip: {\n        show: true\n      },\n      links: [],\n      datasource: null,\n      maxDataPoints: 3,\n      interval: null,\n      targets: [{}],\n      cacheTimeout: null,\n      nullPointMode: 'connected',\n      legendType: 'Under graph',\n      aliasColors: {},\n      format: 'short',\n      valueName: 'current',\n      strokeWidth: 1,\n      fontSize: '80%',\n      combine: {\n        threshold: 0.0,\n        label: 'Others'\n      }\n    };\n\n    _.defaults(this.panel, panelDefaults);\n    _.defaults(this.panel.legend, panelDefaults.legend);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\n\n    appEvents.on('graph-hover', this.onGraphHover.bind(this));\n  }\n\n  onGraphHover(event) {\n    const pos = event.pos;\n    const date = moment.utc(pos.x1);\n    this.focusedTime = date.unix();\n    const index = _.findLastIndex(this.timeBuckets, t=>(t <= this.focusedTime) );\n    if (this.focusedBucketIndex != index) {\n      this.render();\n    }\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-piechart-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n\n    if (this.panel.clickAction === 'Update variable') {\n      this.selectedSeries = {};\n\n      const variable = _.find(this.variableSrv.variables, {'name': this.panel.variableToUpdate});\n      const selected = _.map(_.filter(variable.options, {'selected': true}), 'value');\n      if (selected.constructor === Array) {\n        if (selected[0] === '$__all') {\n          // do nothing\n        } else {\n          for (let i = 0; i < selected.length; i++) {\n            this.selectedSeries[selected[i]] = true;\n          }\n        }\n      }\n    }\n  }\n\n  seriesData(serie) {\n    let data;\n    if (this.panel.valueName != 'time') {\n      data = serie.stats[this.panel.valueName]\n    } else {\n      data = serie.flotpairs[this.focusedBucketIndex][1];\n    }\n    return data;\n  }\n\n  parseSeries(series) {\n    if (series && series.length > 0) {\n      this.timeBuckets = _.map(\n        series[0].flotpairs,\n        arr=>moment.utc(arr[0]).unix()\n      );\n\n      let index = _.findLastIndex(this.timeBuckets, t=>(t <= this.focusedTime) );\n      if (index < 0) {\n        index = 0;\n      }\n      if (index >= this.timeBuckets.length) {\n        index = this.timeBuckets.length - 1;\n      }\n      this.focusedBucketIndex = index;\n    }\n\n    return _.map(series, (serie, i) => {\n      return {\n        label: serie.alias,\n        data: this.seriesData(serie),\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i]\n      };\n    });\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n  }\n\n  seriesHandler(seriesData) {\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    rendering(scope, elem, attrs, ctrl);\n  }\n\n  toggleSeries(serie) {\n    if (this.selectedSeries[serie.label]) {\n      delete this.selectedSeries[serie.alias];\n    } else {\n      this.selectedSeries[serie.label] = true;\n    }\n  }\n\n  onInitPanelActions(actions) {\n    actions.push({text: 'Export CSV', click: 'ctrl.exportCsv()'});\n    actions.push({text: 'Toggle legend', click: 'ctrl.toggleLegend()'});\n  }\n\n  toggleLegend() {\n    this.panel.legend.show = !this.panel.legend.show;\n    this.refresh();\n  }\n\n  exportCsv() {\n    var seriesList = this.series;\n\n    var text = 'sep=;\\n';\n    text += 'Series;Values;Percentage\\n';\n\n    var total = 0;\n    for (var i = 0; i < seriesList.length; i++) {\n      total += seriesList[i].stats[this.panel.valueName];\n    }\n\n    for (i = 0; i < seriesList.length; i++) {\n      var series = seriesList[i]\n      var value = series.formatValue(series.stats[this.panel.valueName]);\n      var pvalue = ((value / total) * 100).toFixed(2) + '%';\n\n      text += series.label + ';';\n      text += value + ';';\n      text += pvalue + '\\n';\n    }\n\n    fileExport.saveSaveBlob(text, 'grafana_data_export.csv');\n  }\n\n  toggleCombinedSeries(combined) {\n    for (var i = 0; i < combined.length; i++) {\n      this.toggleSeries(combined[i]);\n    }\n\n    if (this.selectedSeries[this.panel.combine.label]) {\n      delete this.selectedSeries[this.panel.combine.label];\n    } else {\n      this.selectedSeries[this.panel.combine.label] = true;\n    }\n  }\n\n  updateVariable() {\n    if (this.panel.variableToUpdate) {\n      var selectedSeries = _.keys(this.selectedSeries);\n\n      const variable = _.find(this.variableSrv.variables, {\"name\": this.panel.variableToUpdate});\n      variable.current.text = selectedSeries.join(' + ');\n      variable.current.value = selectedSeries;\n\n      this.variableSrv.updateOptions(variable).then(() => {\n        this.variableSrv.variableUpdated(variable).then(() => {\n          this.$scope.$emit('template-variable-value-updated');\n          this.$scope.$root.$broadcast('refresh');\n        });\n      });\n    }\n  }\n}\n\nPieChartCtrl.templateUrl = 'module.html';\n"]}