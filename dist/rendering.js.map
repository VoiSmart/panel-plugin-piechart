{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","getLegendHeight","panelHeight","css","legend","show","percentage","values","total","length","Math","min","floor","setElementHeight","height","e","console","log","formatter","label","slice","slice_data","decimal","start","fontSize","color","percentageDecimals","formatValue","percent","toFixed","noDataPoints","html","addPieChart","width","size","plotCanvas","plotCss","top","margin","position","backgroundColor","options","series","pie","stroke","parseFloat","strokeWidth","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","i","hiddenSeries","stack","plot","tooltip","bind","event","pos","item","type","detach","body","formatted","showValue","showPercentage","place_tt","pageX","pageY","variable","update","name","_","variableSrv","variables","current","text","value","updateOptions","then","variableUpdated","$emit","$root","$broadcast","incrementRenderCounter","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render(false);\n    if(panel.legendType === 'Right side') {\n      setTimeout(function() { render(true); }, 50);\n    }\n  });\n\n  function getLegendHeight(panelHeight) {\n    if (ctrl.panel.legendType === 'On graph') {\n      $('.graph-legend').css('padding-top', 0);\n    } else {\n      $('.graph-legend').css('padding-top', 6);\n    }\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' || ctrl.panel.legendType === 'On graph') {\n      return 0;\n    }\n\n    if (ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\n      var total = 25 + (21 * data.length);\n      return  Math.min(total, Math.floor(panelHeight/2));\n    }\n\n    return 27;\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height - getLegendHeight(ctrl.height);\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      console.log(e);\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if(ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) +\"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n          combine: {\n          threshold: ctrl.panel.combine.threshold,\n          label: ctrl.panel.combine.label\n        }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: true\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    data = ctrl.data;\n\n    for (let i = 0; i < data.length; i++) {\n      let series = data[i];\n\n      // if hidden remove points and disable stack\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n        series.stack = false;\n      }\n    }\n\n    elem.html(plotCanvas);\n\n    $.plot(plotCanvas, ctrl.data, options);\n    if (ctrl.panel.tooltip.show === true) {\n      plotCanvas.bind(\"plothover plotclick\", function (event, pos, item) {\n        if (event.type == \"plothover\") {\n          if (!item) {\n            $tooltip.detach();\n            return;\n          }\n\n          var body;\n          var percent = parseFloat(item.series.percent).toFixed(2);\n          var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n          body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\n          body += '<div class=\"graph-tooltip-value\">' + item.series.label;\n          if (ctrl.panel.tooltip.showValue === true) {\n            body += ': ' + formatted;\n          }\n          if (ctrl.panel.tooltip.showPercentage === true) {\n            body += \" (\" + percent + \"%)\";\n          }\n          body += \"</div>\";\n          body += \"</div></div>\";\n\n          $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n        } else if (event.type == \"plotclick\") {\n          const label = item.series.label;\n\n          if (ctrl.panel.variable.update && ctrl.panel.variable.name) {\n            const variable = _.find(ctrl.variableSrv.variables, {\"name\": ctrl.panel.variable.name});\n            variable.current.text = label;\n            variable.current.value = label;\n\n            ctrl.variableSrv.updateOptions(variable).then(() => {\n              ctrl.variableSrv.variableUpdated(variable).then(() => {\n                scope.$emit('template-variable-value-updated');\n                scope.$root.$broadcast('refresh');\n              });\n            });\n          }\n        }\n      });\n    } else {\n      $tooltip.detach();\n    }\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addPieChart();\n      }\n    }\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}